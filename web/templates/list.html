{{template "base" .}}

{{define "content"}}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Browse Papers</h1>

    <!-- Search and Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
        <form action="/search" method="get" class="space-y-4">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1 flex gap-2">
                    <input type="text" name="q" value="{{.Query}}" placeholder="Search by title, abstract, or author..."
                        class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white w-full">
                    <button type="submit" class="btn btn-primary md:w-auto">
                        Search
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-2 md:gap-4">
                    <div class="relative w-full md:w-auto">
                        <select name="category"
                            class="appearance-none px-4 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800 dark:bg-gray-700 dark:text-white w-full md:w-auto cursor-pointer bg-white">
                            <option value="">All Categories</option>
                            <option value="cs.AI" {{if eq $.SelectedCategory "cs.AI" }}selected{{end}}>cs.AI -
                                Artificial
                                Intelligence</option>
                            <option value="cs.LG" {{if eq $.SelectedCategory "cs.LG" }}selected{{end}}>cs.LG - Machine
                                Learning
                            </option>
                            <option value="cs.CV" {{if eq $.SelectedCategory "cs.CV" }}selected{{end}}>cs.CV - Computer
                                Vision
                            </option>
                            <option value="cs.CL" {{if eq $.SelectedCategory "cs.CL" }}selected{{end}}>cs.CL -
                                Computation
                                and
                                Language</option>
                            <option value="cs.NE" {{if eq $.SelectedCategory "cs.NE" }}selected{{end}}>cs.NE - Neural
                                Computing
                            </option>
                            <option value="cs.RO" {{if eq $.SelectedCategory "cs.RO" }}selected{{end}}>cs.RO - Robotics
                            </option>
                            <option value="cs.CR" {{if eq $.SelectedCategory "cs.CR" }}selected{{end}}>cs.CR -
                                Cryptography
                            </option>
                            <option value="cs.DB" {{if eq $.SelectedCategory "cs.DB" }}selected{{end}}>cs.DB - Databases
                            </option>
                            <option value="cs.DC" {{if eq $.SelectedCategory "cs.DC" }}selected{{end}}>cs.DC -
                                Distributed
                                Computing</option>
                            <option value="cs.SE" {{if eq $.SelectedCategory "cs.SE" }}selected{{end}}>cs.SE - Software
                                Engineering</option>
                            <option value="math.CO" {{if eq $.SelectedCategory "math.CO" }}selected{{end}}>math.CO -
                                Combinatorics</option>
                            <option value="math.PR" {{if eq $.SelectedCategory "math.PR" }}selected{{end}}>math.PR -
                                Probability
                            </option>
                            <option value="math.ST" {{if eq $.SelectedCategory "math.ST" }}selected{{end}}>math.ST -
                                Statistics
                            </option>
                            <option value="stat.ML" {{if eq $.SelectedCategory "stat.ML" }}selected{{end}}>stat.ML -
                                Machine
                                Learning</option>
                            <option value="quant-ph" {{if eq $.SelectedCategory "quant-ph" }}selected{{end}}>quant-ph -
                                Quantum
                                Physics</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 dark:text-gray-400">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-secondary w-full md:w-auto">
                        Filter
                    </button>

                    {{if or .Query .SelectedCategory}}
                    <a href="/" class="btn btn-outline w-full md:w-auto text-center">
                        Clear Filters
                    </a>
                    {{end}}
                </div>
            </div>
        </form>
    </div>

    <!-- Results Info -->
    <div class="mb-4 text-gray-600 dark:text-gray-400">
        Showing {{len .Papers}} of {{.TotalResults}} papers
    </div>

    <!-- Papers List -->
    <div class="space-y-4">
        {{range .Papers}}
        <div class="paper-card bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow">
            <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                <div class="flex-1 w-full">
                    <h2 class="text-xl font-semibold mb-2">
                        <a href="{{.PDFUrl}}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">
                            {{.Title}}
                        </a>
                    </h2>

                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        {{.Authors}}
                    </p>

                    <p class="text-gray-700 dark:text-gray-300 mb-3 line-clamp-3">
                        {{.Abstract}}
                    </p>

                    <div class="flex flex-wrap items-center gap-4 text-sm">
                        <span class="text-gray-500 dark:text-gray-400">
                            {{.PublishedAt.Format "Jan 2, 2006"}}
                        </span>
                        <span class="text-gray-500 dark:text-gray-400">
                            üè∑Ô∏è {{.Categories}}
                        </span>
                    </div>

                    <!-- Tags -->
                    {{if .Tags}}
                    <div class="mt-3 flex flex-wrap gap-2">
                        {{range .Tags}}
                        <span class="tag">{{.Name}}</span>
                        {{end}}
                    </div>
                    {{end}}
                </div>

                <div class="flex flex-row md:flex-col gap-2 w-full md:w-auto mt-4 md:mt-0 md:ml-4">
                    {{if .InLibrary}}
                    <button hx-post="/library/remove/{{.ID}}" hx-swap="outerHTML"
                        class="btn btn-success flex-1 md:flex-none md:w-full"
                        title="Saved to Library (Click to Remove)">
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </button>
                    {{else}}
                    <button hx-post="/library/add/{{.ID}}" hx-swap="outerHTML"
                        class="btn btn-outline flex-1 md:flex-none md:w-full" title="Save to Library">
                        <i data-lucide="bookmark" class="w-4 h-4"></i>
                    </button>
                    {{end}}

                    <button onclick="copyToClipboard('{{.Title}}', 'Title')"
                        class="btn btn-outline flex-1 md:flex-none md:w-full text-center" title="Copy Title">
                        <i data-lucide="clipboard" class="w-4 h-4"></i>
                    </button>

                    <button onclick="copyToClipboard('{{.PDFUrl}}', 'Link')"
                        class="btn btn-outline flex-1 md:flex-none md:w-full text-center" title="Copy Link">
                        <i data-lucide="link" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
        {{else}}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-12 text-center">
            <p class="text-gray-500 dark:text-gray-400 text-lg">No papers found</p>
            {{if or .Query .SelectedTag}}
            <a href="/" class="btn btn-primary mt-4 inline-block">Clear Filters</a>
            {{else}}
            <p class="text-gray-400 dark:text-gray-500 mt-2">Try refreshing papers from arXiv</p>
            {{end}}
        </div>
        {{end}}
    </div>

    <!-- Pagination -->
    {{if gt .TotalPages 1}}
    <div class="mt-8 flex flex-wrap justify-center items-center gap-2">
        {{if gt .CurrentPage 1}}
        <a href="?page={{sub .CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}{{if .SelectedTag}}&tag={{.SelectedTag}}{{end}}{{if .SelectedCategory}}&category={{.SelectedCategory}}{{end}}"
            class="btn btn-outline">
            ‚Üê Previous
        </a>
        {{end}}

        {{/* Show page numbers 1-10 or up to TotalPages */}}
        {{$maxPages := 10}}
        {{$totalPages := .TotalPages}}
        {{$currentPage := .CurrentPage}}
        {{$query := .Query}}
        {{$selectedTag := .SelectedTag}}
        {{$selectedCategory := .SelectedCategory}}

        {{/* Determine how many page numbers to show */}}
        {{$pagesToShow := $maxPages}}
        {{if lt $totalPages $maxPages}}
        {{$pagesToShow = $totalPages}}
        {{end}}

        {{/* Show page numbers */}}
        {{range $i := until $pagesToShow}}
        {{$pageNum := add $i 1}}
        {{if eq $pageNum $currentPage}}
        <span class="px-4 py-2 bg-red-800 text-white rounded-lg font-medium">{{$pageNum}}</span>
        {{else}}
        <a href="?page={{$pageNum}}{{if $query}}&q={{$query}}{{end}}{{if $selectedTag}}&tag={{$selectedTag}}{{end}}{{if $selectedCategory}}&category={{$selectedCategory}}{{end}}"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            {{$pageNum}}
        </a>
        {{end}}
        {{end}}

        {{/* Show ellipsis and total pages if there are more than 10 pages */}}
        {{if gt $totalPages $maxPages}}
        <span class="text-gray-500 dark:text-gray-400">...</span>
        {{if eq $currentPage $totalPages}}
        <span class="px-4 py-2 bg-red-800 text-white rounded-lg font-medium">{{$totalPages}}</span>
        {{else}}
        <a href="?page={{$totalPages}}{{if $query}}&q={{$query}}{{end}}{{if $selectedTag}}&tag={{$selectedTag}}{{end}}{{if $selectedCategory}}&category={{$selectedCategory}}{{end}}"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            {{$totalPages}}
        </a>
        {{end}}
        {{end}}

        {{if lt .CurrentPage .TotalPages}}
        <a href="?page={{add .CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}{{if .SelectedTag}}&tag={{.SelectedTag}}{{end}}{{if .SelectedCategory}}&category={{.SelectedCategory}}{{end}}"
            class="btn btn-outline">
            Next ‚Üí
        </a>
        {{end}}
    </div>
    {{end}}
</div>
{{end}}