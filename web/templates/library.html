{{template "base" .}}

{{define "content"}}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">My Library</h1>

    <!-- Search and Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
        <form action="/library" method="get" class="space-y-4">
            <div class="flex gap-4">
                <input type="text" name="q" value="{{.Query}}" placeholder="Search your library..."
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                <button type="submit" class="btn btn-primary">
                    Search
                </button>
            </div>

            <div class="flex gap-4">
                <select name="tag"
                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    <option value="">All Tags</option>
                    {{range .Tags}}
                    <option value="{{.Name}}" {{if eq $.SelectedTag .Name}}selected{{end}}>{{.Name}}</option>
                    {{end}}
                </select>

                <button type="submit" class="btn btn-secondary">
                    Filter
                </button>

                {{if or .Query .SelectedTag}}
                <a href="/library" class="btn btn-outline">
                    Clear Filters
                </a>
                {{end}}
            </div>
        </form>
    </div>

    <!-- Results Info -->
    <div class="mb-4 text-gray-600 dark:text-gray-400">
        {{.TotalResults}} papers in your library
    </div>

    <!-- Papers List -->
    <div class="space-y-4">
        {{range .Papers}}
        <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow {{if .IsRead}}opacity-75{{end}}">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    {{if .IsRead}}
                    <span
                        class="inline-block px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 dark:bg-green-900 dark:text-green-200 rounded mb-2">
                        ‚úì Read
                    </span>
                    {{end}}

                    <h2 class="text-xl font-semibold mb-2">
                        <a href="/paper/{{.ID}}" class="text-blue-600 dark:text-blue-400 hover:underline">
                            {{.Title}}
                        </a>
                    </h2>

                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        {{.Authors}}
                    </p>

                    <p class="text-gray-700 dark:text-gray-300 mb-3 line-clamp-2">
                        {{.Abstract}}
                    </p>

                    <div class="flex items-center gap-4 text-sm">
                        <span class="text-gray-500 dark:text-gray-400">
                            {{.PublishedAt.Format "Jan 2, 2006"}}
                        </span>
                        <span class="text-gray-500 dark:text-gray-400">
                            üè∑Ô∏è {{.Categories}}
                        </span>
                    </div>

                    <!-- Tags -->
                    {{if .Tags}}
                    <div class="mt-3 flex flex-wrap gap-2">
                        {{range .Tags}}
                        <span class="tag">{{.Name}}</span>
                        {{end}}
                    </div>
                    {{end}}
                </div>

                <div class="ml-4 flex flex-col gap-2">
                    <button hx-post="/library/toggle-read/{{.ID}}" hx-swap="outerHTML"
                        class="{{if .IsRead}}btn btn-sm btn-success{{else}}btn btn-sm btn-outline{{end}}">
                        {{if .IsRead}}‚úì Read{{else}}Mark as Read{{end}}
                    </button>

                    <button hx-post="/library/remove/{{.ID}}" hx-swap="outerHTML" class="btn btn-sm btn-secondary">
                        Remove
                    </button>

                    <a href="{{.PDFUrl}}" target="_blank" class="btn btn-sm btn-outline text-center">
                        üìÑ PDF
                    </a>
                </div>
            </div>
        </div>
        {{else}}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-12 text-center">
            <p class="text-gray-500 dark:text-gray-400 text-lg">Your library is empty</p>
            <a href="/" class="btn btn-primary mt-4 inline-block">Browse Papers</a>
        </div>
        {{end}}
    </div>

    <!-- Pagination -->
    {{if gt .TotalPages 1}}
    <div class="mt-8 flex justify-center gap-2">
        {{if gt .CurrentPage 1}}
        <a href="/library?page={{sub .CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}{{if .SelectedTag}}&tag={{.SelectedTag}}{{end}}"
            class="btn btn-outline">
            ‚Üê Previous
        </a>
        {{end}}

        <span class="px-4 py-2 text-gray-700 dark:text-gray-300">
            Page {{.CurrentPage}} of {{.TotalPages}}
        </span>

        {{if lt .CurrentPage .TotalPages}}
        <a href="/library?page={{add .CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}{{if .SelectedTag}}&tag={{.SelectedTag}}{{end}}"
            class="btn btn-outline">
            Next ‚Üí
        </a>
        {{end}}
    </div>
    {{end}}
</div>
{{end}}